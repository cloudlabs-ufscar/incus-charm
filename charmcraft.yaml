# This file configures Charmcraft.
# See https://juju.is/docs/sdk/charmcraft-config for guidance.

# (Required)
name: incus


# (Required)
type: charm


# (Recommended)
title: Incus Charm


# (Required)
summary: Charmed Incus.


# (Required)
description: |
  The charm is an automated way to deploy and operate Incus.

  The charm deploys an Incus cluster across all units. Integrations with
  external network and storage services such as Ceph and OVN is provided,
  as well as integrations with auth and monitoring services.

  Incus can be used as a replacement for LXD or, depending on the use case,
  even more sophisticated solutions such as OpenStack. The charm provides an
  automated way of deploying and operating Incus.

  The charm is useful for operators who wish to deploy and operate Incus.


# (Required for 'charm' type)
bases:
  - build-on:
    - name: ubuntu
      channel: "22.04"
    run-on:
    - name: ubuntu
      channel: "22.04"

assumes:
  - juju >= 3.5.0

# (Optional) Configuration options for the charm
# This config section defines charm config options, and populates the Configure
# tab on Charmhub.
# More information on this section at https://juju.is/docs/sdk/charmcraft-yaml#heading--config
# General configuration documentation: https://juju.is/docs/sdk/config
config:
  options:
    # An example config option to customise the log level of the workload
    server-port:
      description: |
        The port for the Incus API server.
      default: 8443
      type: int
    cluster-port:
      description: |
        The port for the Incus cluster communication.

        Note that Incus does not support changing the cluster address after
        the member joins the cluster. Because of this, any changes to this
        option after the cluster is formed will be ignored on existing
        units, but may be applied to new units.
      default: 8444
      type: int
    metrics-port:
      description: |
        The port in which Incus will expose the metrics server to be scraped by Prometheus.
      type: int
      default: 8443
    ceph-rbd-features:
      description: |
        Comma-separated list of RBD features to enable for volumes on the Ceph
        storage pool.

        To see all available features, refer to the Ceph RBD documentation:
        https://docs.ceph.com/en/latest/man/8/rbd/#cmdoption-rbd-image-feature
      default: layering
      type: string
    package-repository:
      description: |
        A full source list entry to define an extra package repository.

        A complete reference for the format of the source list entry
        is available at https://wiki.debian.org/SourcesList.
      default: deb https://pkgs.zabbly.com/incus/stable jammy main
      type: string
    package-repository-gpg-key:
      description: |
        An optional URL from which to download the GPG key used to verify the
        package signatures in the repository specified in `package-repository`.
      default: https://pkgs.zabbly.com/key.asc
      type: string
    set-failure-domain:
      description: |
        When enabled, the charm will use Juju's availability zones to set the failure
        domain of each node in the cluster.

        For more information about failure domains, refer to the Incus documentation:
        https://linuxcontainers.org/incus/docs/main/explanation/clustering/#failure-domains
      default: true
      type: boolean
    enable-web-ui:
      description: |
        Whether to enable the Incus Web UI.
      default: false
      type: boolean

actions:
  add-trusted-certificate:
    description: Add a trusted certificate to the Incus daemon.
    params:
      name:
        description: The certificate name (optional)
        type: string
      projects:
        description: A comma separated list of projects to restrict the client certificate to (optional)
        type: string
      cert:
        description: |
          The raw X.509 PEM client certificate.

          The file can be passed as:
          $ juju run incus/leader add-trusted-certificate cert="$(cat client.crt)"
        type: string
      type:
        description: |
          The type of certificate to be added. Can be either "client" (the default) or "metrics".
        type: string
        default: client
    required:
      - cert
    additionalProperties: false
  add-trusted-client:
    description: |
      Generate a Incus trust token that can be used by the client to add itself to the trust store.
    params:
      name:
        description: The client name
        type: string
      projects:
        description: A comma separated list of projects to restrict the client certificate to (optional)
        type: string
    required:
      - name
    additionalProperties: false
  cluster-list:
    description: List all cluster members and their state. Equivalent to the `incus cluster list` command.
    params:
      format:
        description: |
          The output format. Can be one of: csv, json, table, yaml, compact.
        default: table
        type: string
    additionalProperties: false

extra-bindings:
  public:
  monitoring:

peers:
  cluster:
    interface: incus-cluster

requires:
  certificates:
    interface: tls-certificates
    optional: true
    limit: 1
  ceph:
    interface: ceph-client
    limit: 1
    optional: true
  ovsdb-cms:
    interface: ovsdb-cms
    limit: 1
    optional: true

parts:
  charm:
    build-packages:
      - build-essential
      - libffi-dev
      - libssl-dev
      - python3-dev
    build-snaps:
      - rustup
    override-build: |
      rustup default stable
      craftctl default
