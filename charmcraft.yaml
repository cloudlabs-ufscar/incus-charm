# This file configures Charmcraft.
# See https://juju.is/docs/sdk/charmcraft-config for guidance.

# (Required)
name: incus


# (Required)
type: charm


# (Recommended)
title: Incus Charm


# (Required)
summary: Charmed Incus.


# (Required)
description: |
  The charm is an automated way to deploy and operate Incus.

  The charm deploys an Incus cluster across all units. Integrations with
  external network and storage services such as Ceph and OVN is provided,
  as well as integrations with auth and monitoring services.

  Incus can be used as a replacement for LXD or, depending on the use case,
  even more sophisticated solutions such as OpenStack. The charm provides an
  automated way of deploying and operating Incus.

  The charm is useful for operators who wish to deploy and operate Incus.


# (Required for 'charm' type)
bases:
  - build-on:
    - name: ubuntu
      channel: "22.04"
    run-on:
    - name: ubuntu
      channel: "22.04"

assumes:
  - juju >= 3.5.0

# (Optional) Configuration options for the charm
# This config section defines charm config options, and populates the Configure
# tab on Charmhub.
# More information on this section at https://juju.is/docs/sdk/charmcraft-yaml#heading--config
# General configuration documentation: https://juju.is/docs/sdk/config
config:
  options:
    # An example config option to customise the log level of the workload
    server-port:
      description: |
        The port for the Incus API server.
      default: 8443
      type: int
    cluster-port:
      description: |
        The port for the Incus cluster communication.

        Note that Incus does not support changing the cluster address after
        the member joins the cluster. Because of this, any changes to this
        option after the cluster is formed will be ignored on existing
        units, but may be applied to new units.
      default: 8444
      type: int
    metrics-port:
      description: |
        The port in which Incus will expose the metrics server to be scraped by Prometheus.
      type: int
      default: 8443

actions:
  add-trusted-certificate:
    description: Add a trusted certificate to the Incus daemon.
    params:
      name:
        description: The certificate name (optional)
        type: string
      projects:
        description: A comma separated list of projects to restrict the client certificate to (optional)
        type: string
      cert:
        description: |
          The raw X.509 PEM client certificate.

          The file can be passed as:
          $ juju run incus/leader add-trusted-certificate cert="$(cat client.crt)"
        type: string
    required:
      - cert
    additionalProperties: false
  cluster-list:
    description: List all cluster members and their state. Equivalent to the `incus cluster list` command.
    params:
      format:
        description: |
          The output format. Can be one of: csv, json, table, yaml, compact.
        default: table
        type: string
    additionalProperties: false

extra-bindings:
  public:
  monitoring:

peers:
  cluster:
    interface: incus-cluster

requires:
  certificates:
    interface: tls-certificates
    optional: true
    limit: 1
  ceph:
    interface: ceph-client
    limit: 1
    optional: true

parts:
  charm:
    build-packages:
      - build-essential
      - libffi-dev
      - libssl-dev
      - python3-dev
    build-snaps:
      - rustup
    override-build: |
      rustup default stable
      craftctl default
